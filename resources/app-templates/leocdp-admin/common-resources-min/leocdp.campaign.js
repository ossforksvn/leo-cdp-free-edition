'use strict';var campaignReportView=function(c){location.hash="calljs-leoCdpRouter('Campaign_Info','"+c+"')"},campaignEditor=function(c){location.hash="calljs-leoCdpRouter('Campaign_Editor','"+c+"')"},campaignRunImmediately=function(c){console.log("campaignRunImmediately "+c)},campaignScheduler=function(c){console.log("campaignScheduler "+c)},campaignListRefresh=function(){location.hash="#calljs-leoCdpRouter('Automated_Campaigns','_refresh_"+(new Date).getTime()+"')"};
function loadCampaignList(){var c=getUserSession();c&&$("#campaign-list").DataTable({processing:!1,serverSide:!1,serverMethod:"POST",ajax:{url:baseLeoAdminUrl+"/cdp/campaigns/filter",contentType:"application/json",beforeSend:function(a){a.setRequestHeader("leouss",c)},data:function(a){console.log(a);return JSON.stringify(a)}},columnDefs:[{render:function(a,b,d){a=textTruncate(a,60);return'\x3ca title\x3d"'+d.name+'" href\x3d"javascript:campaignReportView(\''+(d.id+"')\" \x3e")+a+"\x3c/a\x3e"},targets:0},
{render:function(a,b,d){b="MANUALLY_CUSTOM";1===a?b="LEAD_GENERATION":2===a?b="REMARKETING":3===a?b="CROSS_SELLING":4===a?b="UPSELLING":5===a&&(b="REFERRAL_PROGRAM");return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+b+"\x3c/div\x3e"},targets:1},{render:function(a,b,d){b="DRAFT";1===a?b="PLANNED":2===a?b="IN_PROGRESS":3===a?b="COMPLETED":4===a?b="CANCELED":-1===a&&(b="DELETED");return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+b+"\x3c/div\x3e"},targets:2},{render:function(a,b,d){return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+
a+"\x3c/div\x3e"},targets:3},{render:function(a,b,d){return moment.utc(new Date(a)).local().format("YYYY-MM-DD HH:mm:ss")},targets:4},{render:function(a,b,d){return a?moment.utc(new Date(a)).local().format("YYYY-MM-DD HH:mm:ss"):"-"},targets:5},{render:function(a,b,d){return a},targets:6},{render:function(a,b,d){a="javascript:campaignRunImmediately('"+d.id+"')";b="javascript:campaignScheduler('"+d.id+"')";d='\x3cdiv style\x3d"width:81px"\x3e \x3ca class\x3d"control" title\x3d"Campaign Details" href\x3d"javascript:campaignReportView(\''+
(d.id+'\')" \x3e\x3ci class\x3d"fa fa-line-chart" aria-hidden\x3d"true"\x3e\x3c/i\x3e Details\x3c/a\x3e \x3cbr\x3e\x3ca class\x3d"control" title\x3d"Campaign Editor" href\x3d"javascript:campaignEditor(\'')+(d.id+'\')" \x3e\x3ci class\x3d"fa fa-pencil-square-o" aria-hidden\x3d"true"\x3e\x3c/i\x3e  Edit\x3c/a\x3e \x3cbr\x3e');return d=d+('\x3ca class\x3d"control" title\x3d"Schedule campaign" href\x3d"'+b+'" \x3e\x3ci class\x3d"fa fa-clock-o" aria-hidden\x3d"true"\x3e\x3c/i\x3e Schedule\x3c/a\x3e  \x3cbr\x3e\x3ca class\x3d"control" title\x3d"Run campaign immediately" href\x3d"')+
(a+'" \x3e\x3ci class\x3d"fa fa-play" aria-hidden\x3d"true"\x3e\x3c/i\x3e Run \x3c/a\x3e \x3c/div\x3e')},targets:7}],columns:[{data:"name"},{data:"type"},{data:"status"},{data:"targetedSegmentId"},{data:"updatedAt"},{data:"lastRunAt"},{data:"ownerUsername"},{data:"automatedFlow"}]})}
function loadCampaignEditor(c){LeoAdminApiUtil.callPostAdminApi(baseLeoAdminUrl+"/cdp/campaign/get",{id:c},function(a){if(0===a.httpCode&&""===a.errorMessage){if(a.canEditData?$("button.data-control-edit").click(function(){location.hash="calljs-leoCdpRouter('Campaign_Editor','"+c+"')"}):$("button.data-control-edit").attr("disabled","disabled"),campaignModel=a.data)a=campaignModel.name,document.title="Campaign Details: "+a,$("#cp_title").text(a),loadAutomatedFlow()}else LeoAdminApiUtil.logErrorPayload(a)})}
function loadAutomatedFlow(){mermaid.initialize({startOnLoad:!1,securityLevel:"loose",useMaxWidth:!0});var c=jsonToMermaid(automatedFlowJsonData);console.log("jsonToMermaid \n ",c);const a=document.getElementById("mermaidOutput");(function(){mermaid.render("id",c).then(({svg:d,bindFunctions:f})=>{a.innerHTML=d;f&&f(a)});automatedFlowJsonData=mermaidToJSON(c);const b=JSON.stringify(automatedFlowJsonData,null,2);console.log("mermaidToJSON:",b);console.log("mermaidToJSON \x3d\x3d\x3d automatedFlowJsonData:",
b===automatedFlowJsonData)})()}function automatedFlowNodeClick(c){console.log(c);notifySuccessMessage(c)}
function mermaidToJSON(c){c=c.split("\n").map(b=>b.trim()).filter(b=>b);const a=automatedFlowJsonData;a.rules=[];c.forEach(b=>{b=b.trim();try{if(b.startsWith("flowchart"))a.type="flowchart";else if(b.includes("--\x3e")){var [d,f]=b.split("--\x3e"),[,e,g]=f.includes("|")?f.split("|"):[null,f];e=e?e.trim():null;g=g?g.trim().replace(/ \[\[|\]\] /g,""):e;a.rules.push({start:d.trim(),conditionResult:e&&e!=g?e:null,end:g})}else if(b.includes("[")){const h=b.split("[")[0].trim(),l=b.match(/\[(.*?)\]/)?.[1].trim();
var k=a.nodes[h];"object"===typeof k?(k.id=h,k.label=l):a.nodes[h]={id:h,label:l}}else console.log("mermaidToJSON, skip line: ",b)}catch(h){console.log("error",b)}});return a}
function jsonToMermaid(c){let a=`${c.type} ${"LR"}\n`;Object.values(c.nodes).forEach(b=>{a+=`${b.id}[${b.label}]\n`;a+=`click ${b.id} href "javascript:automatedFlowNodeClick('${b.id}')"\n`});c.rules.forEach(b=>{b.conditionResult?(b.conditionResult=b.conditionResult,a+=`${b.start} -->|${b.conditionResult}| ${b.end}\n`):a+=`${b.start} --> ${b.end}\n`});return a}
var automatedFlowJsonData={type:"flowchart",nodes:{S_2a7hPxmTiyLYoTe1TTTkvU:{id:"S_2a7hPxmTiyLYoTe1TTTkvU",type:"data_node",label:"Targeted Segment: \x3cbr\x3e Shopping Cart Abandoners \x3cimg class\x3d'targetedSegmentIcon' src\x3d'https://cdn-icons-png.flaticon.com/128/4577/4577216.png'\x3e",actions:['context.loadProfilesInSegment("2a7hPxmTiyLYoTe1TTTkvU")']},C_isRightTimeToSend_1:{id:"C_isRightTimeToSend_1",type:"condition_node",label:'\x3cimg class\x3d"questionIcon" src\x3d"https://cdn-icons-png.flaticon.com/128/189/189665.png" /\x3e  Is time to do actions ? \x3cbr\x3e \x3cdiv class\x3d\'nodeInfo\'\x3e $Now.Date \x3d\x3d 20-05-2024 \x3c/div\x3e',
condition:'context.profile.isCurrentDateEqual("20-05-2024")'},A_sendEmail:{id:"A_sendEmail",type:"action_node",label:'Send email  \x3cimg class\x3d"actionIcon" src\x3d"https://cdn-icons-png.flaticon.com/128/3062/3062634.png" /\x3e',actions:['context.profile.sendEmail("template_id")']},END:{id:"END",type:"end_node",label:'\x3cimg src\x3d"https://cdn-icons-png.flaticon.com/64/5277/5277603.png" /\x3e',actions:["context.end()"]}},rules:[{start:"S_2a7hPxmTiyLYoTe1TTTkvU",conditionResult:null,end:"C_isRightTimeToSend_1"},
{start:"C_isRightTimeToSend_1",conditionResult:"true",end:"A_sendEmail"},{start:"C_isRightTimeToSend_1",conditionResult:"false",end:"END"},{start:"A_sendEmail",conditionResult:null,end:"END"}]};